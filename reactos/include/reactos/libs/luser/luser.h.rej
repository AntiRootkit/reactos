***************
*** 1,28 ****
  #ifndef _NTOSKRNL_LUSER_OVERRIDE_H
  #define _NTOSKRNL_LUSER_OVERRIDE_H
  
  extern void LuserSetGlobalDescriptorTable(void *);
  extern void LuserGetGlobalDescriptorTable(void *);
  extern void LuserSetLocalDescriptorTable(int);
  extern int  LuserGetLocalDescriptorTable();
  extern void LuserSetInterruptDescriptorTable(void *);
  extern void LuserGetInterruptDescriptorTable(void *);
- extern void LuserSetDS(int ds);
- extern int LuserGetDS();
- extern void LuserSetES(int es);
- extern int LuserGetES();
- extern void LuserSetFS(int fs);
- extern int LuserGetFS();
- extern void LuserSetSS(int ss);
- extern int LuserGetSS();
  extern void LuserSetTR(int tr);
  extern int LuserGetTR();
- extern void LuserWriteFSDword(int offset, unsigned long word);
- extern unsigned long LuserReadFSDword(int offset);
- extern void LuserWriteFSWord(int offset, unsigned long word);
- extern unsigned long LuserReadFSWord(int offset);
- extern void LuserWriteFSByte(int offset, unsigned long word);
- extern unsigned long LuserReadFSByte(int offset);
  extern void LuserWriteCR(int cr, unsigned long newCR);
  extern unsigned long LuserReadCR(int cr);
  extern void LuserWriteDR(int dr, unsigned long newDR);
--- 1,17 ----
  #ifndef _NTOSKRNL_LUSER_OVERRIDE_H
  #define _NTOSKRNL_LUSER_OVERRIDE_H
  
+ #include "lunix.h"
+ #include "lstorage.h"
+ 
  extern void LuserSetGlobalDescriptorTable(void *);
  extern void LuserGetGlobalDescriptorTable(void *);
  extern void LuserSetLocalDescriptorTable(int);
  extern int  LuserGetLocalDescriptorTable();
  extern void LuserSetInterruptDescriptorTable(void *);
  extern void LuserGetInterruptDescriptorTable(void *);
  extern void LuserSetTR(int tr);
  extern int LuserGetTR();
  extern void LuserWriteCR(int cr, unsigned long newCR);
  extern unsigned long LuserReadCR(int cr);
  extern void LuserWriteDR(int dr, unsigned long newDR);
***************
*** 31,40 ****
  extern void LuserWrmsr(unsigned long Msr, unsigned long ValHi, unsigned long ValLo);
  extern void LuserRdmsr(unsigned long Msr, unsigned long *ValHi, unsigned long *ValLo);
  extern void LuserGetTrapEntry(int Trap, void *IdtEntry);
- extern void LuserGetTSS(void *Tss);
  
  extern void Printf(const char *fmt, ...);
  
  #ifdef Ke386SetGlobalDescriptorTable
  #undef Ke386SetGlobalDescriptorTable
  #endif 
--- 20,44 ----
  extern void LuserWrmsr(unsigned long Msr, unsigned long ValHi, unsigned long ValLo);
  extern void LuserRdmsr(unsigned long Msr, unsigned long *ValHi, unsigned long *ValLo);
  extern void LuserGetTrapEntry(int Trap, void *IdtEntry);
+ extern int LuserGetTSS(void *Tss);
+ extern unsigned int LuserInByte(int dx);
+ extern unsigned int LuserInWord(int dx);
+ extern unsigned int LuserInDWord(int dx);
+ extern void LuserOutByte(int dx, int val);
+ extern void LuserOutWord(int dx, int val);
+ extern void LuserOutDWord(int dx, int val);
+ extern int LuserReadInterrupt();
+ extern void LuserHaltProcessor();
  
  extern void Printf(const char *fmt, ...);
  
+ typedef void (*LUSER_PAGE_FAULT_HANDLER)(siginfo_t *info, void *addr);
+ extern LUSER_PAGE_FAULT_HANDLER LuserPageFaultHandler;
+ void LuserDefaultHandlePageFault(siginfo_t *info, void *addr);
+ 
+ void LuserRegisterSigstack();
+ void LuserRegisterSegv();
+ 
  #ifdef Ke386SetGlobalDescriptorTable
  #undef Ke386SetGlobalDescriptorTable
  #endif 
***************
*** 65,75 ****
  #endif
  #define Ke386GetInterruptDescriptorTable(x) LuserGetInterruptDescriptorTable(&x)
  
- #ifdef Ke386HaltProcessor
- #undef Ke386HaltProcessor
- #endif
- #define Ke386HaltProcessor() 
- 
  #ifdef Ke386SaveFlags
  #undef Ke386SaveFlags
  #endif
--- 69,74 ----
  #endif
  #define Ke386GetInterruptDescriptorTable(x) LuserGetInterruptDescriptorTable(&x)
  
  #ifdef Ke386SaveFlags
  #undef Ke386SaveFlags
  #endif
***************
*** 102,147 ****
  #endif
  #define Ke386FnInit() 
  
- #ifdef Ke386SetDs
- #undef Ke386SetDs
- #endif
- #define Ke386SetDs LuserSetDS
- 
- #ifdef Ke386GetDs
- #undef Ke386GetDs
- #endif
- #define Ke386GetDs LuserGetDS
- 
- #ifdef Ke386SetEs
- #undef Ke386SetEs
- #endif
- #define Ke386SetEs LuserSetES
- 
- #ifdef Ke386GetEs
- #undef Ke386GetEs
- #endif
- #define Ke386GetEs LuserGetES
- 
- #ifdef Ke386SetFs
- #undef Ke386SetFs
- #endif
- #define Ke386SetFs LuserSetFS
- 
- #ifdef Ke386GetFs
- #undef Ke386GetFs
- #endif
- #define Ke386GetFs LuserGetFS
- 
- #ifdef Ke386SetSs
- #undef Ke386SetSs
- #endif
- #define Ke386SetSs LuserSetSS
- 
- #ifdef Ke386GetSs
- #undef Ke386GetSs
- #endif
- #define Ke386GetSs LuserGetSS
- 
  #ifdef Ke386SetTr
  #undef Ke386SetTr
  #endif
--- 101,106 ----
  #endif
  #define Ke386FnInit() 
  
  #ifdef Ke386SetTr
  #undef Ke386SetTr
  #endif
***************
*** 150,186 ****
  #ifdef Ke386GetTr
  #undef Ke386GetTr
  #endif
- #define Ke386GetTr LuserGetTR
- 
- #ifdef __writefsdword
- #undef __writefsdword
- #endif
- #define __writefsdword LuserWriteFSDword
- 
- #ifdef __readfsdword
- #undef __readfsdword
- #endif
- #define __readfsdword LuserReadFSDword
- 
- #ifdef __writefsword
- #undef __writefsword
- #endif
- #define __writefsword LuserWriteFSWord
- 
- #ifdef __readfsword
- #undef __readfsword
- #endif
- #define __readfsword LuserReadFSWord
- 
- #ifdef __writefsbyte
- #undef __writefsbyte
- #endif
- #define __writefsbyte LuserWriteFSByte
- 
- #ifdef __readfsbyte
- #undef __readfsbyte
- #endif
- #define __readfsbyte LuserReadFSByte
  
  #ifdef __readcr0
  #undef __readcr0
--- 109,115 ----
  #ifdef Ke386GetTr
  #undef Ke386GetTr
  #endif
+ #define Ke386GetTr(x) (x = LuserGetTR())
  
  #ifdef __readcr0
  #undef __readcr0
